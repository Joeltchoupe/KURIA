{
  "name": "Kuria â€” Alert Routing",
  "description": "Route les alertes critiques vers les bons canaux (email + slack)",
  "trigger": "webhook",
  "active": true,
  "nodes": [
    {
      "name": "Alert Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [200, 300],
      "parameters": {
        "httpMethod": "POST",
        "path": "alerts/route",
        "authentication": "headerAuth",
        "headerAuth": {
          "name": "x-api-key",
          "value": "={{$env.KURIA_API_KEY}}"
        }
      }
    },
    {
      "name": "Classify Severity",
      "type": "n8n-nodes-base.switch",
      "position": [400, 300],
      "parameters": {
        "rules": [
          {
            "value": "={{$json.severity}}",
            "operation": "equals",
            "output": 0,
            "value2": "critical"
          },
          {
            "value": "={{$json.severity}}",
            "operation": "equals",
            "output": 1,
            "value2": "warning"
          }
        ],
        "fallbackOutput": 2
      }
    },
    {
      "name": "Critical â€” Email + Slack",
      "type": "n8n-nodes-base.httpRequest",
      "position": [700, 150],
      "parameters": {
        "method": "POST",
        "url": "={{$env.KURIA_API_URL}}/api/notifications/alert",
        "headers": {
          "x-api-key": "={{$env.KURIA_API_KEY}}",
          "Content-Type": "application/json"
        },
        "body": "{\"severity\": \"critical\", \"channel\": \"both\", \"message\": \"={{$json.message}}\", \"company_id\": \"={{$json.company_id}}\"}"
      }
    },
    {
      "name": "Warning â€” Slack Only",
      "type": "n8n-nodes-base.slack",
      "position": [700, 300],
      "parameters": {
        "channel": "#kuria-alerts",
        "text": "ðŸŸ¡ Warning for {{$json.company_id}}: {{$json.message}}"
      }
    },
    {
      "name": "Info â€” Log Only",
      "type": "n8n-nodes-base.supabase",
      "position": [700, 450],
      "parameters": {
        "operation": "insert",
        "table": "action_logs",
        "columns": "company_id,agent_type,event_type,description",
        "additionalFields": {
          "company_id": "={{$json.company_id}}",
          "agent_type": "system",
          "event_type": "alert.info",
          "description": "={{$json.message}}"
        }
      }
    }
  ]
}
