{
  "name": "Kuria — Approval Flow (Pending Actions B)",
  "description": "Gère les actions Risk B en attente d'approbation. Expire après 72h.",
  "trigger": "cron",
  "active": true,
  "nodes": [
    {
      "name": "CRON Every Hour",
      "type": "n8n-nodes-base.cron",
      "position": [200, 300],
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "custom",
              "cronExpression": "0 * * * *"
            }
          ]
        }
      }
    },
    {
      "name": "Get Pending Actions",
      "type": "n8n-nodes-base.supabase",
      "position": [400, 300],
      "parameters": {
        "operation": "getAll",
        "table": "actions",
        "filters": {
          "status": "pending_approval"
        }
      }
    },
    {
      "name": "Split Actions",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [600, 300],
      "parameters": {
        "batchSize": 1
      }
    },
    {
      "name": "Check Expiry",
      "type": "n8n-nodes-base.if",
      "position": [800, 300],
      "parameters": {
        "conditions": {
          "dateTime": [
            {
              "value1": "={{$json.expires_at}}",
              "operation": "isBefore",
              "value2": "={{new Date().toISOString()}}"
            }
          ]
        }
      }
    },
    {
      "name": "Expire Action",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1000, 200],
      "parameters": {
        "method": "POST",
        "url": "={{$env.KURIA_API_URL}}/api/actions/expire",
        "headers": {
          "x-api-key": "={{$env.KURIA_API_KEY}}",
          "Content-Type": "application/json"
        },
        "body": "{\"action_id\": \"={{$json.id}}\"}"
      }
    },
    {
      "name": "Send Reminder",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1000, 400],
      "parameters": {
        "method": "POST",
        "url": "={{$env.KURIA_API_URL}}/api/notifications/approval-reminder",
        "headers": {
          "x-api-key": "={{$env.KURIA_API_KEY}}",
          "Content-Type": "application/json"
        },
        "body": "{\"action_id\": \"={{$json.id}}\", \"company_id\": \"={{$json.company_id}}\"}"
      }
    }
  ]
}
